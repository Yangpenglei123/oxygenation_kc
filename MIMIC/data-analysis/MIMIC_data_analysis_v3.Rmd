---
title: Oxygen project using MIMIC data
author: Willem van den Boom
date: December 31, 2018
output:
  html_document: default
editor_options:
  chunk_output_type: inline
---


```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, results='hide'}
if(!require(bigrquery)) {
  install.packages("bigrquery")
  library("bigrquery")
}

# Project ID from Google Cloud
project_id <- "oxygenators-209612"
options(httr_oauth_cache=FALSE)

# Wrapper for running BigQuery queries.
run_query <- function(query){
    data <- query_exec(query, project=project_id, use_legacy_sql = FALSE, max_pages = Inf)
    return(data)
}

# Library for fitting generalized additive models (GAMs)
library(mgcv)
if(!require(mgcv)) {
  install.packages("mgcv")
  library("mgcv")
}
```



# Read in the data

```{r, eval=FALSE}
patient <- run_query('
SELECT * FROM mimiciii_clinical.mimic_final_patient_results
')
```

```{r, eval=FALSE}
oxygen_therapy <- run_query('
SELECT * FROM mimiciii_clinical.mimic_oxygen_therapy
')
```

```{r, eval=FALSE}
O2measurement <- run_query('
SELECT * FROM mimiciii_clinical.measurements_results
')
```

```{r include=FALSE, eval=FALSE}
save.image(file = "RData/MIMIC_data_analysis_v3_checkpoint_1.RData")
```

```{r loadData, include=FALSE, eval=TRUE}
# Since Google authentication cannot happen when knitting an R Markdown file,
# I load the results from BigQuery from an RData file.
load("RData/MIMIC_data_analysis_v3_checkpoint_1.RData")
```


Height and weight are not available for most ICU stays. This corresponds with the number provided here: (https://opendata.stackexchange.com/questions/6397/is-the-patients-height-available).

Some of the following code has been copied directly from `eICU_data_analysis_v8.Rmd`.

# Data preprocessing


## Body mass index

Compute the body mass index of each patient.

```{r}
# Remove heights above 3 meter and below .5 meter.
patient$height[patient$height > 300 | patient$height < 50] <- NA

# Remove weights below 20kg and above 600kg
patient$weight[patient$weight < 20 | patient$weight > 600] <- NA

# Compute the body mass index
patient$bmi <- patient$weight / (patient$height/100)^2

# Remove BMIs below 15 or above 100
patient$bmi[patient$bmi < 15 | patient$bmi > 100] <- NA
```


## Gender

Transform gender to a factor rather than string
Set genders that are neither male nor female as missing, effectively excluding these from the analysis
```{r}
if(is.character(patient$gender)) patient$gender_string <- patient$gender
summary(as.factor(patient$gender_string))

patient$gender <- NA
patient$gender[patient$gender_string == "Female"] = "F"
patient$gender[patient$gender_string == "Male"] = "M"
patient$gender[patient$gender_string == "F"] = "F"
patient$gender[patient$gender_string == "M"] = "M"

patient$gender = as.factor(patient$gender)
```


## ICU type

We do no grouping ICU type here since the data come from one hospital. See (https://mimic.physionet.org/mimictables/transfers/) for a list of ICU types.

```{r}
patient$unit_type <- as.factor(patient$unittype)
```


## Determine first stay

```{r firstStay}
patient$first_stay <- patient$icustay_seq == 1
```





# Ventilation times

We are only interested in the first ventilation session.
We also record the oxygen therapy type, which is based on which "type" of ventilation records appear most often.

```{r determineVentilation, eval=FALSE}
## This block of code can also be done from inside SQL.
# Only keep the first ventilations
oxygen_therapy <- oxygen_therapy[oxygen_therapy$ventnum_seq == 1,]

cat("Are the ICU stay IDs in `oxygen_therapy` unique?", !any(duplicated(oxygen_therapy$icustay_id)))

pat2ot <- match(oxygen_therapy$icustay_id, patient$icustay_id)

patient$vent_duration <- NA_integer_
patient$oxygen_therapy_type <- NA_character_

# Ventilation duration in minuts
patient$vent_duration[pat2ot] <- oxygen_therapy$duration_hours*60

patient$oxygen_therapy_type[pat2ot] <- ifelse(
  oxygen_therapy$mech_vent >= oxygen_therapy$oxygen_therapy,
  "Mechanical ventilation",
  "Supplemental oxygen"
)
patient$oxygen_therapy_type <- as.factor(patient$oxygen_therapy_type)

rm(pat2ot, oxygen_therapy)

mean(is.na(patient$vent_duration))
mean(patient$vent_duration >= 60*24, na.rm = TRUE)
mean(patient$vent_duration >= 60*24*2, na.rm = TRUE)
mean(patient$vent_duration >= 60*24*3, na.rm = TRUE)
```


# Oxygen measurements

We remove oxygen measurements that are outside of the range [10, 100]
```{r}
O2measurement <- O2measurement[O2measurement$spO2_Value <= 100 & O2measurement$spO2_Value >= 10,]
```

Count the number of oxygen measurements per first ventilation of ICU stay
Since we only need these counts for the first ICU stay, we constrain ourselves to this subset for speed.
We only count measurements that happen during the first oxygen therapy session, and we are only interested in those receiving oxygen for at least 24 or `time_limit` hours with at least 12 (`nOxy_limit`) SpO2 measurements.

```{r}
nOxy_limit_min <- 12
time_limit_min <- 60*24
```

```{r countOxygen, include=TRUE, eval=FALSE}
tmp <- unique(O2measurement$icustay_id)
tmp <- tmp[!(tmp %in% patient$icustay_id[patient$first_stay & patient$vent_duration >= time_limit_min])]
tmp <- table(O2measurement$icustay_id, exclude = tmp)

patient$nOxy <- as.numeric(tmp[match(patient$icustay_id, names(tmp))])
rm(tmp)

# ICU stays that do not have any measurements are currently NA and should be 0.
patient$nOxy[which(is.na(patient$nOxy) & patient$vent_duration >= time_limit_min)] <- 0


# Delete O2measurements that belong to patients that won't be in the selected subset
tmp_IDs <- patient$icustay_id[which(patient$vent_duration >= time_limit_min & patient$nOxy >= nOxy_limit_min)]

O2measurement <- O2measurement[O2measurement$icustay_id %in% tmp_IDs,]

rm(tmp_IDs)

mean(patient$nOxy[which(patient$vent_duration >= time_limit_min)] >= nOxy_limit_min)
mean(patient$nOxy[which(patient$vent_duration >= 2*time_limit_min)] >= 2*nOxy_limit_min)
```



# Determine high ventilation

TBD - See eICU




# Subset selection

The following code selects cases of interest while also providing the info required for a flow diagram: That is, how many patients did not meet the inclusion criteria.

```{r}
cat("Total number of ICU stays:", nrow(patient))

# We only keep first stays with at least 48 hours of ventilation
tmp <- which(patient$first_stay)
cat("\nNumber of first stays:", length(tmp))
cat("\nNumber of repeat stays:", sum(patient$first_stay == FALSE, na.rm = TRUE))
cat("\nNumber of patients for whom we couldn't determine first stays:", length(unique(patient$patient_ID[is.na(patient$first_stay)])))
patient_subset <- patient[tmp,]



# Ages above 89 are recorded as "> 89" in the eICU data
# The current SQL code translates "> 89" to "89" such that we cannot distinguish between 89 and >89.
# As we use age as a confounder, we remove those with age 89.
# We only consider "adults" (age >= 16).
tmp <- patient_subset$age < 16 | patient_subset$age >= 89
sum(patient_subset$age < 16, na.rm = TRUE)
sum(patient_subset$age >= 89, na.rm = TRUE)
cat("\nPatients outside age range:", sum(tmp, na.rm = TRUE))
cat("\nPatients with missing age:", sum(is.na(tmp)))
tmp[is.na(tmp)] <- TRUE

# `delete` records which cases to delete from patient
delete <- tmp

# Delete those whose gender is unknown or other
tmp <- is.na(patient_subset$gender)
cat("\nPatients with missing or 'other' gender:", sum(tmp))
delete <- delete | tmp


# Delete those with missing BMI
tmp <- is.na(patient_subset$bmi)
cat("\nPatients with missing BMI:", sum(tmp))
delete <- delete | tmp


# Delete those with missing SOFA score
tmp <- is.na(patient_subset$sofatotal)
cat("\nPatients with missing SOFA score:", sum(tmp))
delete <- delete | tmp



cat("\nPatients selected so far:", sum(!delete))

patient_subset <- patient_subset[!delete,]


time_limit <- 24*60#48*60
tmp <- patient_subset$vent_duration >= time_limit
sum(is.na(tmp))
tmp <- which(tmp)
cat("\nNumber of first ventilations of at least 48 hours:", length(tmp))
patient_subset <- patient_subset[tmp,]



cat("Number of selected patients so far:", nrow(patient_subset))




# Delete those with fewer than 24 oxygen measurements
nOxy_limit <- 12#24
delete <- patient_subset$nOxy < nOxy_limit
cat("\nPatients with too few measurements:", sum(delete), "out of", nrow(patient_subset))

patient_subset <- patient_subset[!delete,]


### We do not subset by `high_vent_proportion` since this is not recorded for those on supplemental oxygen.
### Tidal volume is also often not recorded for those on noninvasive ventilation.
## Commented out because we do not (yet) compute high_vent_proportion.
#table(is.na(patient_subset$high_vent_proportion), patient_subset$oxygen_therapy_type)


cat("\nPatients selected:", nrow(patient_subset))

summary(as.factor(patient_subset$oxygen_therapy_type))
#sum(tmp <- is.na(patient_subset$high_vent_proportion) & patient_subset$oxygen_therapy_type >= 2)


rm(delete, tmp)
```



## Cleaning

This code is not necessary for MIMIC since no NAs appear.

```{r}
# Delete O2measurements that belong to patients not in the selected subset
O2measurement <- O2measurement[O2measurement$icustay_id %in% patient_subset$icustay_id,]

# Cases with no diagnoses from ICD-9 codes have all diagnoses as "NA"
# These should be FALSE.
for(j in which(grepl("has_", names(patient_subset)))) {
  patient_subset[is.na(patient_subset[,j]), j] <- FALSE
}
rm(j)

patient_subset$CHF[is.na(patient_subset$CHF)] <- FALSE
patient_subset$AF[is.na(patient_subset$AF)] <- FALSE
patient_subset$CAD[is.na(patient_subset$CAD)] <- FALSE
patient_subset$CKD[is.na(patient_subset$CKD)] <- FALSE
```


## Demographics

Let us compare the demographics before and after the subset selection.

```{r}
# Variables of which we like summaries
tmp <- c('age', 'gender', 'bmi', 'sofatotal', 'unit_type', 'nOxy', 'mortality_in_ICU')

cat("Mortality in 'patient':", sum(patient$mortality_in_ICU), "\n")
summary(patient[patient$age >= 16,tmp])

cat("Mortality in 'patient_subset':", sum(patient_subset$mortality_in_ICU), "\n")
summary(patient_subset[,tmp])
```


```{r include=FALSE, eval=FALSE}
save.image(file = "RData/MIMIC_data_analysis_v3_checkpoint_1_1.RData")
```



# Compute summaries of oxygen measurements

We compute the median oxygen level and the proportion of measurements below 94% and proportion above 97% oxygen saturation.
We do this after subset selection as it is much faster to compute these only for the subset of interest.

We currently ignore the time aspect of the measurements. However, one should probably take into account that certain measurements are less spread out than others.

```{r oxygenSummaries, eval=FALSE}
patient_subset$median <- NA_real_
patient_subset$propBelow <- NA_real_
patient_subset$propAbove <- NA_real_
n <- nrow(patient_subset)
pb <- txtProgressBar(max = n, style = 3)

for(i in 1:n) {
  tmp <- O2measurement$spO2_Value[
    O2measurement$icustay_id == patient_subset$icustay_id[i]
  ]
  
  patient_subset$median[i] <- median(tmp)
  patient_subset$propBelow[i] <- mean(tmp < 94)
  patient_subset$propAbove[i] <- mean(tmp > 97)
  
  setTxtProgressBar(pb, i)
}
close(pb)
rm(i,tmp,pb,O2measurement)

# Proportion of measurements from 94 to 97
patient_subset$prop <- 1 - patient_subset$propBelow - patient_subset$propAbove

summary(patient_subset$median)
summary(patient_subset$prop)
```





```{r include=FALSE, eval=FALSE}
save.image("RData/MIMIC_data_analysis_v3_checkpoint2.RData")
```

```{r loadProcessedData, include=FALSE, eval=TRUE}
# Since computing the oxygen summaries takes a long time,
# I load the results from an RData file.
load("RData/MIMIC_data_analysis_v3_checkpoint2.RData")
```


```{r include=FALSE, eval=FALSE}
# Upload patient_subset to BigQuery to make it available outside of R
ds <- bq_table(project = project_id, dataset = "mimiciii_clinical", table = "patient_cohort")

if(bq_table_exists(ds)) bq_table_delete(ds)

bq_table_upload(
  x = ds,
  values = patient_subset,
  quiet = FALSE
)

rm(ds)
```




# Model fitting


Let us first define functions to visualize the GAM fits.
```{r plotFunctions}
plot_width <- 4.2126 # The Lancet asks for plots to have a width of 107mm.
font <- "Times" # Text in figures should be Times New Roman according to the Lancet.
point_size <- 10 # Per Lancet instructions


logistic <- function(x) 1/(1+exp(-x))

gam_plotMed <- function(gamfitMed,
                    main = "Median of measurements",
                    xRange = c(92, 100),
                    yRange = c(0, .6)
) {
print(paste("Number of cases:", summary(gamfitMed)$n))

xlab <- expression("Median oxygen saturation (SpO"[2]*")")
ylab <- "Probability of ICU mortality" 

xName <- "median"

# Color for dotted line
colD <- "Black"

    plot(1, type = 'n', xlim = xRange, ylim = yRange,
         ylab = ylab,
         xlab = xlab, main = main, yaxs = 'i', xaxs = 'i', yaxt = 'n', xaxt = 'n')
    
    att <- pretty(yRange)
if(!isTRUE(all.equal(att, round(att, digits = 2)))) {
  axis(2, at = att, lab = paste0(sprintf('%.1f', att*100), '%'), las = TRUE)
} else axis(2, at = att, lab = paste0(att*100, '%'), las = TRUE)
    
    att <- pretty(xRange)
    axis(1, at = att, lab = paste0(att, '%'), las = TRUE)

    
    eval(parse(text = paste(c('predictionsPlusCI <- predict(gamfitMed, newdata = data.frame(',
                              xName, ' = gamfitMed$model$', xName, ", gender = 'F', age = median(gamfitMed$model$age), bmi = median(gamfitMed$model$bmi),",
                      ifelse(
                        "high_vent_proportion" %in% colnames(gamfitMed$model),
                        "high_vent_proportion = median(gamfitMed$model$high_vent_proportion),",
                        ""
                      ),
                      ifelse(
                        "apsiii" %in% colnames(gamfitMed$model),
                        "apsiii = median(gamfitMed$model$apsiii),",
                        "sofatotal = median(gamfitMed$model$sofatotal),"
                      ),
                      "hospital_id = 264), type = 'link', se.fit = T)"), collapse = "")))

  
  # We have to use the data on which GAM was fit for confidence region as the GAM does not provide standard errors for 'new' input
  eval(parse(text = paste0('xx <- gamfitMed$model$', xName)))
  ord.index <- order(xx)
  xx <- xx[ord.index]
  
  if(gamfitMed$family$link == 'logit') {
    lcl <- logistic(predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index])
    ucl <- logistic(predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index])
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2, col = colD)
    lines(x = xx, y = ucl, lty = 2, lwd = 2, col = colD)
    lines(xx, logistic(predictionsPlusCI$fit[ord.index]), lwd = 3)
  } else {
    lcl <- predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index]
    ucl <- predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index]
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2)
    lines(x = xx, y = ucl, lty = 2, lwd = 2)
    lines(xx, predictionsPlusCI$fit[ord.index], lwd = 3)
  }
}



gam_plotProp <- function(gamfitProp, main = "Effect of treatment regime", yRange = c(0, .6), add = FALSE, col = "black"){
  print(paste("Number of cases:", summary(gamfitProp)$n))
  
  xName <- colnames(gamfitProp$model)[grep("prop", colnames(gamfitProp$model))]
  
  xRange = c(0, max(patient_subset[,xName], na.rm= TRUE))
  
  
  if(xName == "propBelow") {
    xlab <- expression("Proportion of SpO"[2]*" below 94% (black) or above 97% (blue)")
    #xlab <- expression("Proportion of  SpO"[2]*" measurements below 94%")
  } else if(xName == "propAbove") {
    xlab <- expression("Proportion of SpO"[2]*" measurements above 97%")
  } else {
    xlab <- expression("Proportion of SpO"[2]*" measurements within 94% to 97%")
  }
  
  ylab <- "Probability of ICU mortality" 
  
  if(!add) {
    plot(1, type = 'n', xlim = xRange, ylim = yRange,
           ylab = ylab,
           xlab = xlab, main = main, yaxs = 'i', xaxs = 'i', yaxt = 'n', xaxt = 'n')
      
      att <- pretty(yRange)
    if(!isTRUE(all.equal(att, round(att, digits = 2)))) {
      axis(2, at = att, lab = paste0(sprintf('%.1f', att*100), '%'), las = TRUE)
    } else axis(2, at = att, lab = paste0(att*100, '%'), las = TRUE)
      
      att <- pretty(xRange)
      axis(1, at = att, lab = paste0(att*100, '%'), las = TRUE)
  
  }
    
    eval(parse(text = paste(c('predictionsPlusCI <- predict(gamfitProp, newdata = data.frame(',
                              xName, ' = gamfitProp$model$', xName, ", gender = 'F', age = median(gamfitProp$model$age), bmi = median(gamfitProp$model$bmi),",
                      ifelse(
                        "high_vent_proportion" %in% colnames(gamfitProp$model),
                        "high_vent_proportion = median(gamfitProp$model$high_vent_proportion),",
                        ""
                      ),
                      ifelse(
                        "apsiii" %in% colnames(gamfitProp$model),
                        "apsiii = median(gamfitProp$model$apsiii),",
                        "sofatotal = median(gamfitProp$model$sofatotal),"
                      ),
                      "hospital_id = 264), type = 'link', se.fit = T)"), collapse = "")))
    
    
  
  # We have to use the data on which GAM was fit for confidence region as the GAM does not provide standard errors for 'new' input
  eval(parse(text = paste0('xx <- gamfitProp$model$', xName)))
  ord.index <- order(xx)
  xx <- xx[ord.index]
  
  if(gamfitProp$family$link == 'logit') {
    lcl <- logistic(predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index])
    ucl <- logistic(predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index])
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2, col = col)
    lines(x = xx, y = ucl, lty = 2, lwd = 2, col = col)
    lines(xx, logistic(predictionsPlusCI$fit[ord.index]), lwd = 3, col = col)
  } else {
    lcl <- predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index]
    ucl <- predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index]
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2, col = col)
    lines(x = xx, y = ucl, lty = 2, lwd = 2, col = col)
    lines(xx, predictionsPlusCI$fit[ord.index], lwd = 3, col = col)
  }
}
```


```{r}
### !!!! Temporary overwrite to check hospital mortality
patient_subset$mortality_in_ICU <- patient_subset$mortality_in_Hospt
```


## Median of measurements

We fit a generalized additive model (GAM) to check for the effect of the median oxygen saturation. GAMs are regression models that allow for nonlinear effects of the predictors.
We add gender and age as predictors to control for them. We also control for hospital but since there are so many hospitals, we add it as a random effect.


```{r gamfitMed}
pdf(file = "Figures/MIMIC_med_v3_24.pdf", width = plot_width,
    height = 6/2, pointsize = point_size, family = font)
#par(mfrow = c(2,1), cex = 1)
gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == "Mechanical ventilation",], family = binomial)
gam_plotMed(gamfitMed, main = "")#, yRange = c(0, .6))

dev.off()
```




## Proportion of measurements within range

We now fit a GAM with the proportion of measurements within a range instead of the median of the measurements.



```{r gamfitProp}
pdf(file = "Figures/MIMIC_prop_v8_24.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == "Mechanical ventilation",], family = binomial)
summary(gamfitProp)
gam_plotProp(gamfitProp, main = "Adherence to oxygen saturation target")


gamfitProp_below <- gam(mortality_in_ICU ~ s(propBelow)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == "Mechanical ventilation",], family = binomial)
summary(gamfitProp_below)
gam_plotProp(gamfitProp_below, main = "Proportion above or below the range")

gamfitProp_above <- gam(mortality_in_ICU ~ s(propAbove)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == "Mechanical ventilation",], family = binomial)
summary(gamfitProp_above)
gam_plotProp(gamfitProp_above, main = "Proportion below", col = "blue", add = TRUE)


dev.off()
```


Same but uncontrolled: (code doesn't work yet)

```{r gamfitProp}
pdf(file = "Figures/MIMIC_prop_uncontrolled_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_u <- gam(mortality_in_ICU ~ s(prop), data = patient_subset, family = binomial)
summary(gamfitProp_u)
gam_plotProp(gamfitProp_u, main = "Adherence to oxygen saturation target")


gamfitProp_below_u <- gam(mortality_in_ICU ~ s(propBelow), data = patient_subset, family = binomial)
summary(gamfitProp_below_u)
gam_plotProp(gamfitProp_below_u, main = "Proportion above or below the range")

gamfitProp_above_u <- gam(mortality_in_ICU ~ s(propAbove), data = patient_subset, family = binomial)
summary(gamfitProp_above_u)
gam_plotProp(gamfitProp_above_u, main = "Proportion below", col = "blue", add = TRUE)


dev.off()
```

