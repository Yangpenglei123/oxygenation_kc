---
title: Oxygen project using eICU data
author: Willem van den Boom
date: January 28, 2019
output:
  html_document: default
editor_options:
  chunk_output_type: inline
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r setup, results='hide'}
if(!require(bigrquery)) {
  install.packages("bigrquery")
  library("bigrquery")
}

# Project ID from Google Cloud
project_id <- "oxygenators-209612"
options(httr_oauth_cache=FALSE)

# Wrapper for running BigQuery queries.
run_query <- function(query){
    data <- query_exec(query, project=project_id, use_legacy_sql = FALSE, max_pages = Inf)
    return(data)
}

# Library for fitting generalized additive models (GAMs)
library(mgcv)
if(!require(mgcv)) {
  install.packages("mgcv")
  library("mgcv")
}
```


# Read in data from eICU

```{r eval=FALSE}
patient <- run_query('
SELECT * FROM eicu.final_patient_results
')

O2measurement <- run_query('
SELECT * FROM eicu.final_measurement_results
')
```

```{r include=FALSE, eval=FALSE}
save(patient, O2measurement, file = "RData/eICU_data_analysis_v8_checkpoint1.RData")
```

```{r loadData, include=FALSE, eval=TRUE}
# Since Google authentication cannot happen when knitting an R Markdown file,
# I load the results from BigQuery from an RData file.
load("RData/eICU_data_analysis_v8_checkpoint1.RData")
```


# Data preprocessing


## Body mass index

Compute the body mass index of each patient.

```{r}
# Remove heights above 3 meter and below .5 meter.
patient$height[patient$height > 300 | patient$height < 50] <- NA

# Remove weights below 20kg and above 600kg
patient$weight[patient$weight < 20 | patient$weight > 600] <- NA

# Compute the body mass index
patient$bmi <- patient$weight / (patient$height/100)^2

# Remove BMIs below 15 or above 100
patient$bmi[patient$bmi < 15 | patient$bmi > 100] <- NA
```


## Gender

Transform gender to a factor rather than string
Set genders that are neither male nor female as missing, effectively excluding these from the analysis
```{r}
if(is.character(patient$gender)) patient$gender_string <- patient$gender
summary(as.factor(patient$gender_string))

patient$gender <- NA
patient$gender[patient$gender_string == "Female"] = "F"
patient$gender[patient$gender_string == "Male"] = "M"

patient$gender = as.factor(patient$gender)
```


## ICU type

Consolidate the various ICU types such that only general, cardiac, and neuro ICU remain.


### From Slack

*Mornin Feng*
The followings are my suggestions:
1/ Just exclude Neuro ICUS
2/ Merge  “Cardiac ICU”
“CCU-CTICU”: Coronary Care Unit / Cardiothoracic ICU
“CTICU”: Cardiothoracic ICU
as CCUs, BUT keep “CSICU”: Cardiac Surgery ICU separately as CSICU
3/ MICU and SICU should not be merged
4/ Med-Surg ICU, KC See what do you think? (edited)


*KC See*
I largely agree with Mornin. The Neuro ICU is unclear what it is - Medical Neuro vs Neurosurgical. For CSICU, I think it is like CTICU. Can we do analysis with and without it, and see if there is a difference? MICU, MSICU, and SICU should be separate. Then if all shows similar results, we can pool everything too

```{r}
patient$unit_type = as.factor(patient$unittype)

#levels(patient$unit_type)[levels(patient$unit_type) %in% c("Med-Surg ICU", "MICU", "SICU")] = "General ICU"
levels(patient$unit_type)[levels(patient$unit_type) %in% c("CCU-CTICU", "CSICU", "CTICU")] = "Cardiac ICU"
```


## Determine first stay

We use `hospitalDischargeYear` and `unit_stay_number` to determine whether an ICU stay was a patient's first.

Note that `unit_stay_number` [does not always start at 1](https://github.com/MIT-LCP/eicu-code/issues/16).
```{r firstStay}
patient$first_stay = NA

for(i in 1:max(patient$unit_stay_number)) {
  tmp_table = table(patient$patient_ID[
    patient$unit_stay_number <= i
    & is.na(patient$first_stay)
  ])
  
  # An ICU stay that is a patient's only one with `unit_stay_number` <= i
  # must be a first stay.
  tmp_index <- patient$patient_ID %in% names(tmp_table)[tmp_table == 1]
  
  patient$first_stay[
     tmp_index
  ] <- FALSE
  
  patient$first_stay[
    tmp_index
    & patient$unit_stay_number <= i
  ] <- TRUE
}


# `hospitalDischargeYear` only takes the values 2014 and 2015
unique(patient$hospitalDischargeYear)

# The remaning NAs in first_stay can only be resolved if a patient
# has only 1 hospital stay with a discharge in 2014
tmp_IDs <- unique(patient$patient_ID[
  is.na(patient$first_stay)
  & patient$hospitalDischargeYear == 2014
])

for(id in tmp_IDs) {
  tmp_index <- which(
    patient$patient_ID == id &
    patient$hospitalDischargeYear == 2014
  )
  
  if(length(tmp_index) == 1) {
    patient$first_stay[patient$patient_ID == id] <- FALSE
    patient$first_stay[tmp_index] <- TRUE
  }
}

rm(tmp_table, tmp_index, tmp_IDs, i, id)

summary(patient$first_stay)
length(unique(patient$patient_ID))
length(unique(patient$patient_ID[is.na(patient$first_stay)]))
```




# Ventilation times

We determine the ventilation times based on a variety of data tables.
We do not use `respiratorycare` since its time stamps [are not recorded correctly](https://github.com/MIT-LCP/eicu-code/issues/49).

In `nursecharting`, we look at the presence of a positive oxygen flow or oxygen admin devices that indicate oxygen therapy.
We are only interested in positive oxygen flows. Also, we ignore what happens more than an hour in advance of ICU admission.
`respiratorycharting.respchartvaluelabel` sometimes indicates ventilation.
All this is contained in the SQL view `oxygen_therapy`.Furthermore, `type` indicates whether the entry suggests invasive ventilation (4), noninvasive ventilation (3), either invasive or noninvasive ventilation (2), supplemental oxygen (1). If the entry does not suggest a type of oxygen therapy, `type = 0`.
```{r loadOxygenTherapyData, eval=FALSE}
oxygen_therapy <- run_query('
SELECT * FROM eicu.oxygen_therapy
')
```

`treatment.treatmentstring` sometimes indicates ventilation. We load its oxygen therapy entries in a seperate view as `treatment` includes `activeUponDischarge` which the other tables do not.
```{r load_treatment, eval=FALSE}
oxygen_therapy_treatment <- run_query('
SELECT * FROM eicu.oxygen_therapy_treatment
')
```

```{r include=FALSE, eval=FALSE}
save.image(file = "RData/eICU_data_analysis_v8_checkpoint_vent.RData")
```

Oxygen flows and respiratorycharting entries are usually recorded every 60 minutes and oxygen administration devices mostly in at most 2 hour intervals but we allow for gaps of up to 24*60 minutes.
Treatment is recorded irregularly but mostly more often than every day (24*60 minutes). So, we also allow gaps there.
```{r determineVentilation, eval=FALSE}
tmp_IDs <- unique(patient$icustay_id[patient$first_stay & !is.na(patient$first_stay)])

# We only keep entries in `oxygen_therapy` and `oxygen_therapy_treatment` that appear in tmp_IDs for computational efficiency.
oxygen_therapy <- oxygen_therapy[oxygen_therapy$icustay_id %in% tmp_IDs,]
oxygen_therapy_treatment <- oxygen_therapy_treatment[oxygen_therapy_treatment$icustay_id %in% tmp_IDs,]

tmp_IDs <- unique(c(oxygen_therapy$icustay_id, oxygen_therapy_treatment$icustay_id))
n <- length(tmp_IDs)

patient$vent_start <- NA_integer_
patient$vent_end <- NA_integer_
patient$oxygen_therapy_type <- NA_integer_

pb <- txtProgressBar(max = n, style = 3)
for(i in 1:n) {
  id <- tmp_IDs[i]
  patient_ind <- which(patient$icustay_id == id)
  
  tmp_treatment <- oxygen_therapy_treatment[oxygen_therapy_treatment$icustay_id == id, -1]
  tmp_therapy <- oxygen_therapy[oxygen_therapy$icustay_id == id, -1]
  times <- sort(c(tmp_therapy$time, tmp_treatment$time))
  patient$vent_start[patient_ind] <- times[1]
  
  n_times <- length(times)
  
  breaks <- diff(times) > 60*24
  
  if(!any(breaks)) {
    patient$vent_end[patient_ind] <- times[n_times]
  } else {
    patient$vent_end[patient_ind] <- times[which(breaks)[1]]
  }
  
  if(any(tmp_treatment$activeUponDischarge)) {
    last_treatment_time <- min(tmp_treatment$time[which(tmp_treatment$activeUponDischarge)])
    if(last_treatment_time <= patient$vent_end[patient_ind])   {
      patient$vent_end[patient_ind] <- max(
        # The ventilation end time cannot be later/longer than the ICU length of stay
        last_treatment_time,
        24*60*patient$icu_length_of_stay[patient_ind]
      )
    }
  }
  
  # Determine the oxygen therapy type
  patient$oxygen_therapy_type[patient_ind] <- max(c(
    tmp_therapy$type[tmp_therapy$time >= patient$vent_start[patient_ind] & tmp_therapy$time <= patient$vent_end[patient_ind]],
    tmp_treatment$type[tmp_treatment$time >= patient$vent_start[patient_ind] & tmp_treatment$time <= patient$vent_end[patient_ind]]
  ))
  
  setTxtProgressBar(pb, i)
}
close(pb)

rm(tmp_IDs, n, id, times, n_times, breaks, i, pb, oxygen_therapy, oxygen_therapy_treatment, last_treatment_time, tmp_treatment, tmp_therapy, patient_ind)

# End time is currently a charting time
# Since these are usually recorded hourly, ventilation is actually longer
patient$vent_end <- patient$vent_end + 60
```


```{r include=FALSE, eval=FALSE}
save.image(file = "RData/eICU_data_analysis_v8_checkpoint_vent2.RData")
```

```{r include=FALSE, eval=TRUE}
load(file = "RData/eICU_data_analysis_v8_checkpoint_vent2.RData")
```

```{r}
mean(is.na(patient$vent_start))
mean(is.na(patient$vent_end))
summary(patient$vent_duration <- patient$vent_end - patient$vent_start)
mean(patient$vent_duration >= 60*24, na.rm = TRUE)
mean(patient$vent_duration >= 60*24*2, na.rm = TRUE)
mean(patient$vent_duration >= 60*24*3, na.rm = TRUE)
```



# Oxygen measurements

We remove oxygen measurements that are outside of the range [10, 100]
```{r}
O2measurement <- O2measurement[O2measurement$spO2_Value <= 100 & O2measurement$spO2_Value >= 10,]
```

Count the number of oxygen measurements per first ventilation of ICU stay
Since we only need these counts for the first ICU stay, we constrain ourselves to this subset for speed.
We only count measurements that happen during the first oxygen therapy session, and we are only interested in those receiving oxygen for at least 48 or `time_limit` hours.

```{r}
nOxy_limit <- 24
time_limit <- 60*24*2
```

```{r countOxygen, include=TRUE, eval=FALSE}
tmp <- unique(O2measurement$icustay_id)
tmp <- tmp[!(tmp %in% patient$icustay_id[patient$first_stay & patient$vent_duration >= time_limit])]
tmp <- table(O2measurement$icustay_id, exclude = tmp)

patient$nOxy <- as.numeric(tmp[match(patient$icustay_id, names(tmp))])
rm(tmp)

# ICU stays that do not have any measurements are currently NA and should be 0.
patient$nOxy[which(is.na(patient$nOxy) & patient$vent_duration >= time_limit)] <- 0


# We've counted all oxygen measurements.
# We should only be counting the measurements that happen during ventilation
tmp_IDs <- patient$icustay_id[which(patient$vent_duration >= time_limit & patient$nOxy >= nOxy_limit)]
n <- length(tmp_IDs)

# Delete O2measurements that belong to patients that won't be in the selected subset
O2measurement <- O2measurement[O2measurement$icustay_id %in% tmp_IDs,]

index <- match(tmp_IDs, patient$icustay_id)

pb <- txtProgressBar(max = n, style = 3)
for(i in 1:n) {
  ind <- index[i]
  
  patient$nOxy[ind] <- sum(
    O2measurement$icustay_id == tmp_IDs[i]
    & O2measurement$measurement_time >= patient$vent_start[ind]
    & O2measurement$measurement_time <= patient$vent_end[ind]
  )
  
  setTxtProgressBar(pb, i)
}
close(pb)
rm(pb, i, index, tmp_IDs, n, ind)
```

```{r include=FALSE, eval=FALSE}
save.image(file = "RData/eICU_data_analysis_v8_checkpoint_vent2_2.RData")
```

```{r include=FALSE, eval=TRUE}
load(file = "RData/eICU_data_analysis_v8_checkpoint_vent2_2.RData")
```

```{r}
mean(patient$nOxy[which(patient$vent_duration >= time_limit)] >= nOxy_limit)
```



# Determine high ventilation

Let us compute what proportion of the ventilation time the tidal volume is above 6.5 milliliter per kilogram of body mass. For that, we first load data from `respiratorycharting`.

```{r include=TRUE, eval=FALSE}
tidal_volume <- run_query('
SELECT patientunitstayid as icustay_id,
		respchartoffset as time,
    MAX(SAFE_CAST(respchartvalue as FLOAT64)) as TV
FROM `oxygenators-209612.eicu.respiratorycharting`
WHERE respchartvaluelabel = "TV/kg IBW"
GROUP BY patientunitstayid, respchartoffset
')
```


Compute proportion of tidal volume >= 6.5 but only for those with more than `nOxy_limit` oxygen measurements. We only consider tidal volumes recorded during the ventilation session.

```{r include=TRUE, eval=FALSE}
# Only keep entries in `tidal_volume` of ICU stays with at least `nOxy_limit` oxygen measurements.
tidal_volume <- tidal_volume[tidal_volume$icustay_id %in% patient$icustay_id[patient$nOxy >= nOxy_limit], ]

patient$high_vent_proportion <- NA_real_

tmp <- unique(tidal_volume$icustay_id)

n <- length(tmp)
pb <- txtProgressBar(max = n, style = 3)
for(i in 1:n) {
  id <- tmp[i]
  
  tmp_TV <- tidal_volume[tidal_volume$icustay_id == id,]
  
  ind <- which(patient$icustay_id == id)
  
  patient$high_vent_proportion[ind] <- mean(
    tmp_TV$TV[
      tmp_TV$time >= patient$vent_start[ind] &
        tmp_TV$time <= patient$vent_end[ind]
    ] >= 6.5
  )
  
  setTxtProgressBar(pb, i)
}
close(pb)

rm(i, id, ind, n, pb, tidal_volume, tmp, tmp_TV)
```

```{r include=FALSE, eval=FALSE}
save.image(file = "RData/eICU_data_analysis_v8_checkpoint_vent2_3.RData")
```

```{r include=FALSE, eval=TRUE}
load(file = "RData/eICU_data_analysis_v8_checkpoint_vent2_3.RData")
```

```{r}
summary(patient$high_vent_proportion)
summary(is.na(patient$high_vent_proportion))
```



# Subset selection

The following code selects cases of interest while also providing the info required for a flow diagram: That is, how many patients did not meet the inclusion criteria.

```{r}
cat("Total number of ICU stays:", nrow(patient))

# We only keep first stays with at least 48 hours of ventilation
tmp <- which(patient$first_stay)
cat("\nNumber of first stays:", length(tmp))
cat("\nNumber of repeat stays:", sum(patient$first_stay == FALSE, na.rm = TRUE))
cat("\nNumber of patients for whom we couldn't determine first stays:", length(unique(patient$patient_ID[is.na(patient$first_stay)])))
patient_subset <- patient[tmp,]



# Ages above 89 are recorded as "> 89" in the eICU data
# The current SQL code translates "> 89" to "89" such that we cannot distinguish between 89 and >89.
# As we use age as a confounder, we remove those with age 89.
# We only consider "adults" (age >= 16).
tmp <- patient_subset$age < 16 | patient_subset$age == 89
sum(patient_subset$age < 16, na.rm = TRUE)
sum(patient_subset$age == 89, na.rm = TRUE)
cat("\nPatients outside age range:", sum(tmp, na.rm = TRUE))
cat("\nPatients with missing age:", sum(is.na(tmp)))
tmp[is.na(tmp)] <- TRUE

# `delete` records which cases to delete from patient
delete <- tmp

# Delete those whose gender is unknown or other
tmp <- is.na(patient_subset$gender)
cat("\nPatients with missing or 'other' gender:", sum(tmp))
delete <- delete | tmp


# Delete those with missing BMI
tmp <- is.na(patient_subset$bmi)
cat("\nPatients with missing BMI:", sum(tmp))
delete <- delete | tmp


# Delete those with missing SOFA score
tmp <- is.na(patient_subset$sofatotal)
cat("\nPatients with missing SOFA score:", sum(tmp))
delete <- delete | tmp



cat("\nPatients selected so far:", sum(!delete))

patient_subset <- patient_subset[!delete,]


tmp <- patient_subset$vent_duration >= time_limit
sum(is.na(tmp))
tmp <- which(tmp)
cat("\nNumber of first ventilations of at least 48 hours:", length(tmp))
patient_subset <- patient_subset[tmp,]



cat("Number of selected patients so far:", nrow(patient_subset))




# Delete those with fewer than 24 oxygen measurements
delete <- patient_subset$nOxy < nOxy_limit
cat("\nPatients with too few measurements:", sum(delete), "out of", nrow(patient_subset))

patient_subset <- patient_subset[!delete,]


### We do not subset by `high_vent_proportion` since this is not recorded for those on supplemental oxygen.
### Tidal volume is also often not recorded for those on noninvasive ventilation.
table(is.na(patient_subset$high_vent_proportion), patient_subset$oxygen_therapy_type)


cat("\nPatients selected:", nrow(patient_subset))

summary(as.factor(patient_subset$oxygen_therapy_type))
sum(tmp <- is.na(patient_subset$high_vent_proportion) & patient_subset$oxygen_therapy_type >= 2)


cat("\nCases with supplemental oxygen selected:", sum(patient_subset$oxygen_therapy_type == 1) )

cat("\nCases with mechanical ventilation selected:", sum(patient_subset$oxygen_therapy_type >= 2 & !tmp) )

rm(delete, tmp)
```



## Cleaning

```{r}
# Delete O2measurements that belong to patients not in the selected subset
O2measurement <- O2measurement[O2measurement$icustay_id %in% patient_subset$icustay_id,]

# Cases with no diagnoses from ICD-9 codes have all diagnoses as "NA"
# These should be FALSE.
for(j in which(grepl("has_", names(patient_subset)))) {
  patient_subset[is.na(patient_subset[,j]), j] <- FALSE
}
rm(j)

patient_subset$CHF[is.na(patient_subset$CHF)] <- FALSE
patient_subset$AF[is.na(patient_subset$AF)] <- FALSE
patient_subset$CAD[is.na(patient_subset$CAD)] <- FALSE
patient_subset$CKD[is.na(patient_subset$CKD)] <- FALSE
```


## Demographics

Let us compare the demographics before and after the subset selection.

```{r}
# Variables of which we like summaries
tmp <- c('age', 'gender', 'bmi', 'sofatotal', 'unit_type', 'nOxy', 'mortality_in_ICU')

cat("Mortality in 'patient':", sum(patient$mortality_in_ICU), "\n")
summary(patient[patient$age >= 16,tmp])

cat("Mortality in 'patient_subset':", sum(patient_subset$mortality_in_ICU), "\n")
summary(patient_subset[,tmp])
```


```{r include=FALSE, eval=FALSE}
save.image(file = "RData/eICU_data_analysis_v8_checkpoint_vent3.RData")
```


# Compute summaries of oxygen measurements

We compute the median oxygen level and the proportion of measurements below 94% and proportion above 97% oxygen saturation.
We do this after subset selection as it is much faster to compute these only for the subset of interest.

We currently ignore the time aspect of the measurements. However, one should probably take into account that certain measurements are less spread out than others.

```{r oxygenSummaries, eval=FALSE}
patient_subset$median <- NA
patient_subset$propBelow <- NA
patient_subset$propAbove <- NA
n <- nrow(patient_subset)
pb <- txtProgressBar(max = n, style = 3)

for(i in 1:n) {
  tmp <- O2measurement$spO2_Value[
    O2measurement$icustay_id == patient_subset$icustay_id[i]
    & O2measurement$measurement_time >= patient_subset$vent_start[i]
    & O2measurement$measurement_time <= patient_subset$vent_end[i]
  ]
  
  patient_subset$median[i] <- median(tmp)
  patient_subset$propBelow[i] <- mean(tmp < 94)
  patient_subset$propAbove[i] <- mean(tmp > 97)
  
  setTxtProgressBar(pb, i)
}
close(pb)
rm(i,tmp,pb,O2measurement)

# Proportion of measurements from 94 to 97
patient_subset$prop <- 1 - patient_subset$propBelow - patient_subset$propAbove

summary(patient_subset$median)
summary(patient_subset$prop)
```



```{r, include = FALSE, eval = FALSE}
# We only keep hospitals with at least 2 cases
cat("\n Number of hospitals in current subset:", length(unique(patient_subset$hospital_id)))

tmp <- table(patient_subset$hospital_id)
cat("\n Number of hospitals with at least 2 patients:", sum(tmp >= 2))

delete <- patient_subset$hospital_id %in% as.numeric(names(tmp[tmp < 2]))
patient_subset <- patient_subset[!delete,]
patient_subset$hospital_id = as.factor(patient_subset$hospital_id)

cat("\n Number of patients in selected subset:", nrow(patient_subset))

rm(tmp, delete)
```



```{r include=FALSE, eval=FALSE}
save.image("RData/eICU_data_analysis_v8_checkpoint2.RData")
```

```{r loadProcessedData, include=FALSE, eval=TRUE}
# Since computing the oxygen summaries takes a long time,
# I load the results from an RData file.
load("RData/eICU_data_analysis_v8_checkpoint2.RData")
```


```{r include=FALSE, eval=FALSE}
# Upload patient_subset to BigQuery to make it available outside of R

# BigQuery does not seem to always know how to deal with NAs.
# We therefore get rid of some of them before uploading.
patient_subset_temp <- patient_subset

ds <- bq_table(project = project_id, dataset = "eicu", table = "patient_cohort")

if(bq_table_exists(ds)) bq_table_delete(ds)

bq_table_upload(
  x = ds,
  values = patient_subset_temp,
  quiet = FALSE
)

rm(ds, patient_subset_temp)
```




# Model fitting


Let us first define functions to visualize the GAM fits.
```{r plotFunctions}
plot_width <- 4.2126 # The Lancet asks for plots to have a width of 107mm.
font <- "Times" # Text in figures should be Times New Roman according to the Lancet.
point_size <- 10 # Per Lancet instructions


logistic <- function(x) 1/(1+exp(-x))

gam_plotMed <- function(gamfitMed,
                    main = "Median of measurements",
                    xRange = c(92, 100),
                    yRange = c(0, .4)
) {
print(paste("Number of cases:", summary(gamfitMed)$n))

xlab <- expression("Median oxygen saturation (SpO"[2]*")")
ylab <- "Probability of ICU mortality" 

xName <- "median"

# Color for dotted line
colD <- "Black"

    plot(1, type = 'n', xlim = xRange, ylim = yRange,
         ylab = ylab,
         xlab = xlab, main = main, yaxs = 'i', xaxs = 'i', yaxt = 'n', xaxt = 'n')
    
    att <- pretty(yRange)
if(!isTRUE(all.equal(att, round(att, digits = 2)))) {
  axis(2, at = att, lab = paste0(sprintf('%.1f', att*100), '%'), las = TRUE)
} else axis(2, at = att, lab = paste0(att*100, '%'), las = TRUE)
    
    att <- pretty(xRange)
    axis(1, at = att, lab = paste0(att, '%'), las = TRUE)

    
    eval(parse(text = paste(c('predictionsPlusCI <- predict(gamfitMed, newdata = data.frame(',
                              xName, ' = gamfitMed$model$', xName, ", gender = 'F', age = median(gamfitMed$model$age), bmi = median(gamfitMed$model$bmi),",
                      ifelse(
                        "high_vent_proportion" %in% colnames(gamfitMed$model),
                        "high_vent_proportion = median(gamfitMed$model$high_vent_proportion),",
                        ""
                      ),
                      ifelse(
                        "apsiii" %in% colnames(gamfitMed$model),
                        "apsiii = median(gamfitMed$model$apsiii),",
                        "sofatotal = median(gamfitMed$model$sofatotal),"
                      ),
                      "hospital_id = 264), type = 'link', se.fit = T)"), collapse = "")))

  
  # We have to use the data on which GAM was fit for confidence region as the GAM does not provide standard errors for 'new' input
  eval(parse(text = paste0('xx <- gamfitMed$model$', xName)))
  ord.index <- order(xx)
  xx <- xx[ord.index]
  
  if(gamfitMed$family$link == 'logit') {
    lcl <- logistic(predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index])
    ucl <- logistic(predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index])
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2, col = colD)
    lines(x = xx, y = ucl, lty = 2, lwd = 2, col = colD)
    lines(xx, logistic(predictionsPlusCI$fit[ord.index]), lwd = 3)
  } else {
    lcl <- predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index]
    ucl <- predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index]
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2)
    lines(x = xx, y = ucl, lty = 2, lwd = 2)
    lines(xx, predictionsPlusCI$fit[ord.index], lwd = 3)
  }
}



gam_plotProp <- function(gamfitProp, main = "Effect of treatment regime", yRange = c(0, .3), add = FALSE, col = "black"){
  print(paste("Number of cases:", summary(gamfitProp)$n))
  
  xName <- colnames(gamfitProp$model)[grep("prop", colnames(gamfitProp$model))]
  
  xRange = c(0, max(patient_subset[,xName], na.rm= TRUE))
  
  
  if(xName == "propBelow") {
    xlab <- expression("Proportion of SpO"[2]*" below 94% (black) or above 97% (blue)")
    #xlab <- expression("Proportion of  SpO"[2]*" measurements below 94%")
  } else if(xName == "propAbove") {
    xlab <- expression("Proportion of SpO"[2]*" measurements above 97%")
  } else {
    xlab <- expression("Proportion of SpO"[2]*" measurements within 94% to 97%")
  }
  
  ylab <- "Probability of ICU mortality" 
  
  if(!add) {
    plot(1, type = 'n', xlim = xRange, ylim = yRange,
           ylab = ylab,
           xlab = xlab, main = main, yaxs = 'i', xaxs = 'i', yaxt = 'n', xaxt = 'n')
      
      att <- pretty(yRange)
    if(!isTRUE(all.equal(att, round(att, digits = 2)))) {
      axis(2, at = att, lab = paste0(sprintf('%.1f', att*100), '%'), las = TRUE)
    } else axis(2, at = att, lab = paste0(att*100, '%'), las = TRUE)
      
      att <- pretty(xRange)
      axis(1, at = att, lab = paste0(att*100, '%'), las = TRUE)
  
  }
    
    eval(parse(text = paste(c('predictionsPlusCI <- predict(gamfitProp, newdata = data.frame(',
                              xName, ' = gamfitProp$model$', xName, ", gender = 'F', age = median(gamfitProp$model$age), bmi = median(gamfitProp$model$bmi),",
                      ifelse(
                        "high_vent_proportion" %in% colnames(gamfitProp$model),
                        "high_vent_proportion = median(gamfitProp$model$high_vent_proportion),",
                        ""
                      ),
                      ifelse(
                        "apsiii" %in% colnames(gamfitProp$model),
                        "apsiii = median(gamfitProp$model$apsiii),",
                        "sofatotal = median(gamfitProp$model$sofatotal),"
                      ),
                      "hospital_id = 264), type = 'link', se.fit = T)"), collapse = "")))
    
    
  
  # We have to use the data on which GAM was fit for confidence region as the GAM does not provide standard errors for 'new' input
  eval(parse(text = paste0('xx <- gamfitProp$model$', xName)))
  ord.index <- order(xx)
  xx <- xx[ord.index]
  
  if(gamfitProp$family$link == 'logit') {
    lcl <- logistic(predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index])
    ucl <- logistic(predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index])
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2, col = col)
    lines(x = xx, y = ucl, lty = 2, lwd = 2, col = col)
    lines(xx, logistic(predictionsPlusCI$fit[ord.index]), lwd = 3, col = col)
  } else {
    lcl <- predictionsPlusCI$fit[ord.index] - 1.96*predictionsPlusCI$se.fit[ord.index]
    ucl <- predictionsPlusCI$fit[ord.index] + 1.96*predictionsPlusCI$se.fit[ord.index]
    
    lines(x = xx, y = lcl, lty = 2, lwd = 2, col = col)
    lines(x = xx, y = ucl, lty = 2, lwd = 2, col = col)
    lines(xx, predictionsPlusCI$fit[ord.index], lwd = 3, col = col)
  }
}
```





## Median of measurements

We fit a generalized additive model (GAM) to check for the effect of the median oxygen saturation. GAMs are regression models that allow for nonlinear effects of the predictors.
We add gender and age as predictors to control for them. We also control for hospital but since there are so many hospitals, we add it as a random effect.


```{r gamfitMed}
pdf(file = "Figures/med_v8.pdf", width = plot_width,
    height = 6/2, pointsize = point_size, family = font)
#par(mfrow = c(2,1), cex = 1)
gamfitMed <- gamm(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset, family = binomial, random = list(hospital_id = ~ 1), contol=list(sing.tol=.1, maxIter = 500, msMaxIter = 500, msMaxEval = 500, tolerance = 0.1, msTol = 0.1))$gam
#gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset, family = binomial)
gam_plotMed(gamfitMed, main = "", yRange = c(0, .3))

dev.off()
```




## Proportion of measurements within range

We now fit a GAM with the proportion of measurements within a range instead of the median of the measurements.


```{r gamfitProp}
pdf(file = "Figures/prop_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp <- gamm(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset, family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitProp)
gam_plotProp(gamfitProp, main = "Adherence to oxygen saturation target")


gamfitProp_below <- gamm(mortality_in_ICU ~ s(propBelow)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset, family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitProp_below)
gam_plotProp(gamfitProp_below, main = "Proportion above or below the range")

gamfitProp_above <- gamm(mortality_in_ICU ~ s(propAbove)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset, family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitProp_above)
gam_plotProp(gamfitProp_above, main = "Proportion below", col = "blue", add = TRUE)


dev.off()
```




## Odds ratios

Based on the model fits, we can estimate odds ratios, including 95% confidence intervals.

```{r results='hide'}
if(!require("oddsratio")) {
  install.packages("oddsratio")
  library(oddsratio)
}

computeCI <- function(gam_fit, data) {
  
  if("median" %in% colnames(gam_fit$model)) {
  
  tmp <- or_gam(data = data, model = gam_fit, pred = "median", values = c(96, 100))

  cat(
  "The odds ratio of mortality for a median oxygen saturation at 100% versus 96% is ",
  tmp$oddsratio,
  " (95% CI ",
  tmp$`CI_high (97.5%)`,
  " to ",
  tmp$`CI_low (2.5%)`,
  ").\n",
  sep = ""
  )
  
  tmp <- or_gam(data = data, model = gam_fit, pred = "median", values = c(96, 92))

  cat(
  "The odds ratio of mortality for a median oxygen saturation at 92% versus 96% is ",
  tmp$oddsratio,
  " (95% CI ",
  tmp$`CI_high (97.5%)`,
  " to ",
  tmp$`CI_low (2.5%)`,
  ").",
  sep = ""
  )
  
  } else {
    xName <- colnames(gam_fit$model)[grep("prop", colnames(gam_fit$model))]
    tmp <- or_gam(data = data, model = gam_fit, pred = xName, values = c(.8, .4))

  cat(
  "The odds ratio of mortality for a proportion of measurements within the range at 40% versus 80% is ",
  tmp$oddsratio,
  " (95% CI ",
  tmp$`CI_low (2.5%)`,
  " to ",
  tmp$`CI_high (97.5%)`,
  ").",
  sep = ""
  )
  
  }

}
```

```{r}
computeCI(gamfitMed, data = patient_subset)
computeCI(gamfitProp, data = patient_subset)
computeCI(gamfitProp_above, data = patient_subset)
```



Same as above but now without adjusting for covariates

```{r}
tmp <- gam(mortality_in_ICU ~ s(median), data = patient_subset, family = binomial)
computeCI(tmp, data = patient_subset)

tmp <- gam(mortality_in_ICU ~ s(prop), data = patient_subset, family = binomial)
computeCI(tmp, data = patient_subset)

tmp <- gam(mortality_in_ICU ~ s(propAbove), data = patient_subset, family = binomial)
computeCI(tmp, data = patient_subset)
```




## Supplement

Let us now create additional plots for the supplement. First, repeat the median and proportion plots without subsetting by oxygen therapy type.


```{r gamfitProp_vent_type}
pdf(file = "Figures/prop_vent_type_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_supp <- gamm(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == 1,], family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitProp_supp)
gam_plotProp(gamfitProp_supp, main = "Supplemental oxygen")

gamfitProp_vent <- gamm(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal) + s(high_vent_proportion), data = patient_subset[patient_subset$oxygen_therapy_type >= 2,], family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitProp_vent)
gam_plotProp(gamfitProp_vent, main = "Mechanical ventilation")


dev.off()
```


```{r gamfitMed_vent_type}
pdf(file = "Figures/med_vent_type_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_supp <- gamm(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == 1,], family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitMed_supp)
gam_plotMed(gamfitMed_supp, main = "Supplemental oxygen")

gamfitMed_vent <- gamm(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal) + s(high_vent_proportion), data = patient_subset[patient_subset$oxygen_therapy_type >= 2,], family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitMed_vent)
gam_plotMed(gamfitMed_vent, main = "Mechanical ventilation")

dev.off()
```





APACHE score instead of SOFA score as control.

```{r}
pdf(file = "Figures/med_APACHE_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gamm(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(apsiii), data = patient_subset[patient_subset$oxygen_therapy_type == 1,], family = binomial, random = list(hospital_id = ~ 1))$gam
gam_plotMed(gamfitMed_type, main = "Supplemental oxygen")

gamfitMed_type <- gamm(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(apsiii) + s(high_vent_proportion), data = patient_subset[patient_subset$oxygen_therapy_type >= 2,], family = binomial, random = list(hospital_id = ~ 1))$gam
gam_plotMed(gamfitMed_type, main = "Mechanical ventilation")

dev.off()


pdf(file = "Figures/prop_APACHE_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gamm(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(apsiii), data = patient_subset[patient_subset$oxygen_therapy_type == 1,], family = binomial, random = list(hospital_id = ~ 1))$gam
gam_plotProp(gamfitProp_type, main = "Supplemental oxygen")

gamfitProp_type <- gamm(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(apsiii) + s(high_vent_proportion), data = patient_subset[patient_subset$oxygen_therapy_type >= 2,], family = binomial, random = list(hospital_id = ~ 1))$gam
gam_plotProp(gamfitProp_type, main = "Mechanical ventilation")

dev.off()
```




Split out mechanical ventilation into noninvasive and invasive ventilation.

```{r}
pdf(file = "Figures/med_vent_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

# We do not control for `high_vent_proportion` for noninvasive ventilation since it is not available for most.
gamfitMed_type <- gamm(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == 3,], family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitMed_type)
gam_plotMed(gamfitMed_type, main = "Noninvasive ventilation")

gamfitMed_type <- gamm(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal) + s(high_vent_proportion), data = patient_subset[patient_subset$oxygen_therapy_type == 4,], family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitMed_type)
gam_plotMed(gamfitMed_type, main = "Invasive ventilation")

dev.off()


pdf(file = "Figures/prop_vent_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

# We do not control for `high_vent_proportion` for noninvasive ventilation since it is not available for most.
# gamfitProp_type <- gamm(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == 3,], family = binomial, random = list(hospital_id = ~ 1))$gam # Fails to converge due to lack of effect of hospital_id. Therefore, we fit it without the random effect.
gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$oxygen_therapy_type == 3,], family = binomial)
summary(gamfitProp_type)
gam_plotProp(gamfitProp_type, main = "Noninvasive ventilation")

gamfitProp_type <- gamm(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal) + s(high_vent_proportion), data = patient_subset[patient_subset$oxygen_therapy_type == 4,], family = binomial, random = list(hospital_id = ~ 1))$gam
summary(gamfitProp_type)
gam_plotProp(gamfitProp_type, main = "Invasive ventilation")

dev.off()
```


Look at different ICU types. Since some ICU types have so few cases, we do not split up by oxygen therapy type.

```{r}
# Rename the levels for plotting
levels(patient_subset$unit_type)[levels(patient_subset$unit_type) == "Med-Surg ICU"] <- "Medical-Surgical ICU"
levels(patient_subset$unit_type)[levels(patient_subset$unit_type) == "MICU"] <- "Medical ICU"
levels(patient_subset$unit_type)[levels(patient_subset$unit_type) == "SICU"] <- "Surgical ICU"

n_type <- nlevels(patient_subset$unit_type)


pdf(file = "Figures/med_ICU_type_v8.pdf", width = plot_width,
    height = 6 * n_type/2, pointsize = point_size, family = font)
par(mfrow = c(n_type,1), cex = 1)

for(ICU_type in levels(patient_subset$unit_type)) {
  gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$unit_type == ICU_type,], family = binomial)
  gam_plotMed(gamfitMed_type, main = ICU_type)
}

dev.off()


pdf(file = "Figures/prop_ICU_type_v8.pdf", width = plot_width,
    height = 6 * n_type/2, pointsize = point_size, family = font)
par(mfrow = c(n_type,1), cex = 1)

for(ICU_type in levels(patient_subset$unit_type)) {
  gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$unit_type == ICU_type,], family = binomial)
  gam_plotProp(gamfitProp_type, main = ICU_type)
}

dev.off()
```



Split up by whether sepsis was present. Do not add random effect of hospital and do not split by oxygen therapy type because too few cases.
For conciseness, all further comparisons are also done without splitting out oxygen therapy type or controlling for hospital.

```{r sepsis}
pdf(file = "Figures/med_sepsis_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_sepsis,], family = binomial)
gam_plotMed(gamfitMed_type, main = "With sepsis")

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_sepsis,], family = binomial)
gam_plotMed(gamfitMed_type, main = "Without sepsis")

dev.off()


pdf(file = "Figures/prop_sepsis_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_sepsis,], family = binomial)
gam_plotProp(gamfitProp_type, main = "With sepsis")

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_sepsis,], family = binomial)
gam_plotProp(gamfitProp_type, main = "Without sepsis")

dev.off()
```



```{r atrial_fibrillation}
pdf(file = "Figures/med_AF_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$AF,], family = binomial)
gam_plotMed(gamfitMed_type, main = "With atrial fibrillation")

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$AF,], family = binomial)
gam_plotMed(gamfitMed_type, main = "Without atrial fibrillation")

dev.off()


pdf(file = "Figures/prop_AF_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$AF,], family = binomial)
gam_plotProp(gamfitProp_type, main = "With atrial fibrillation")

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$AF,], family = binomial)
gam_plotProp(gamfitProp_type, main = "Without atrial fibrillation")

dev.off()
```



```{r chronic_kidney_disease}
pdf(file = "Figures/med_CKD_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$CKD,], family = binomial)
gam_plotMed(gamfitMed_type, main = "With chronic kidney disease")

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$CKD,], family = binomial)
gam_plotMed(gamfitMed_type, main = "Without chronic kidney disease")

dev.off()


pdf(file = "Figures/prop_CKD_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$CKD,], family = binomial)
gam_plotProp(gamfitProp_type, main = "With chronic kidney disease")

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$CKD,], family = binomial)
gam_plotProp(gamfitProp_type, main = "Without chronic kidney disease")

dev.off()
```



```{r congestive_heart_failure}
pdf(file = "Figures/med_CHF_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$CHF,], family = binomial)
gam_plotMed(gamfitMed_type, main = "With congestive heart failure")

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$CHF,], family = binomial)
gam_plotMed(gamfitMed_type, main = "Without congestive heart failure")

dev.off()


pdf(file = "Figures/prop_CHF_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$CHF,], family = binomial)
gam_plotProp(gamfitProp_type, main = "With congestive heart failure")

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$CHF,], family = binomial)
gam_plotProp(gamfitProp_type, main = "Without congestive heart failure")

dev.off()
```


We have too few people with coronary heart disease to do anything useful:

```{r coronary_heart_disease}
summary(patient_subset$CAD)
```


```{r COPD}
pdf(file = "Figures/med_COPD_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_copd_disease,], family = binomial)
gam_plotMed(gamfitMed_type, main = "With COPD")

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_copd_disease,], family = binomial)
gam_plotMed(gamfitMed_type, main = "Without COPD")

dev.off()


pdf(file = "Figures/prop_COPD_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_copd_disease,], family = binomial)
gam_plotProp(gamfitProp_type, main = "With COPD")

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_copd_disease,], family = binomial)
gam_plotProp(gamfitProp_type, main = "Without COPD")

dev.off()
```


```{r chronic_liver_disease}
pdf(file = "Figures/med_chronic_liver_disease_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_chronic_liver_disease,], family = binomial)
gam_plotMed(gamfitMed_type, main = "With chronic liver disease", yRange = 0:1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_chronic_liver_disease,], family = binomial)
gam_plotMed(gamfitMed_type, main = "Without chronic liver disease")

dev.off()


pdf(file = "Figures/prop_chronic_liver_disease_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_chronic_liver_disease,], family = binomial)
gam_plotProp(gamfitProp_type, main = "With chronic liver disease", yRange = 0:1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_chronic_liver_disease,], family = binomial)
gam_plotProp(gamfitProp_type, main = "Without chronic liver disease")

dev.off()
```


```{r stroke}
pdf(file = "Figures/med_stroke_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_stroke_disease,], family = binomial)
gam_plotMed(gamfitMed_type, main = "With stroke", yRange = 0:1)

gamfitMed_type <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_stroke_disease,], family = binomial)
gam_plotMed(gamfitMed_type, main = "Without stroke")

dev.off()


pdf(file = "Figures/prop_stroke_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_stroke_disease,], family = binomial)
gam_plotProp(gamfitProp_type, main = "With stroke")

gamfitProp_type <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_stroke_disease,], family = binomial)
gam_plotProp(gamfitProp_type, main = "Without stroke")

dev.off()
```


```{r cancer}
pdf(file = "Figures/med_cancer_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_cancer_disease,], family = binomial)
gam_plotMed(gamfitMed, main = "With cancer")

gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_cancer_disease,], family = binomial)
gam_plotMed(gamfitMed, main = "Without cancer")

dev.off()


pdf(file = "Figures/prop_cancer_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_cancer_disease,], family = binomial)
gam_plotProp(gamfitProp, main = "With cancer")

gamfitProp <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_cancer_disease,], family = binomial)
gam_plotProp(gamfitProp, main = "Without cancer")

dev.off()
```



```{r diabetes}
pdf(file = "Figures/med_diabetes_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_diabetes_mellitus_disease,], family = binomial)
gam_plotMed(gamfitMed, main = "With diabetes", yRange = 0:1)

gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_diabetes_mellitus_disease,], family = binomial)
gam_plotMed(gamfitMed, main = "Without diabetes")

dev.off()


pdf(file = "Figures/prop_diabetes_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_diabetes_mellitus_disease,], family = binomial)
gam_plotProp(gamfitProp, main = "With diabetes", yRange = 0:1)

gamfitProp <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_diabetes_mellitus_disease,], family = binomial)
gam_plotProp(gamfitProp, main = "Without diabetes")

dev.off()
```


```{r hypertension}
pdf(file = "Figures/med_hypertension_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_hypertension_disease,], family = binomial)
gam_plotMed(gamfitMed, main = "With hypertension")

gamfitMed <- gam(mortality_in_ICU ~ s(median)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_hypertension_disease,], family = binomial)
gam_plotMed(gamfitMed, main = "Without hypertension")

dev.off()


pdf(file = "Figures/prop_hypertension_v8.pdf", width = plot_width,
    height = 6, pointsize = point_size, family = font)
par(mfrow = c(2,1), cex = 1)

gamfitProp <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[patient_subset$has_hypertension_disease,], family = binomial)
gam_plotProp(gamfitProp, main = "With hypertension")

gamfitProp <- gam(mortality_in_ICU ~ s(prop)+gender+s(age)+s(bmi)+s(sofatotal), data = patient_subset[!patient_subset$has_hypertension_disease,], family = binomial)
gam_plotProp(gamfitProp, main = "Without hypertension")

dev.off()
```
